<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Macadoodles Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0f1115;--card:#151923;--text:#e9eef8;--muted:#9aa4b2;--accent:#23c55e;--danger:#ef4444;--border:#273142}
    *{box-sizing:border-box} html,body,#root{height:100%}
    body{margin:0;background:#0f1115;color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .header{position:sticky;top:0;z-index:10;background:rgba(15,17,21,.6);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .header-row{display:flex;gap:12px;align-items:center;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px}
    .grow{flex:1}
    .btn{background:#1e2430;border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#232a39}
    .input,.select,textarea{background:#0f1320;border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px}
    .badge{background:#1f2937;color:#cbd5e1;padding:4px 8px;border-radius:999px;font-size:12px}
    .summary{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px}
    .card .content{padding:14px 16px}
    .card .title{color:var(--muted);font-size:13px;margin-bottom:8px;display:flex;gap:6px;align-items:center}
    .card .big{font-size:24px;font-weight:700}
    .filters{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:12px;padding:0 16px 12px}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .red{color:var(--danger)}
    .pill{border:1px solid var(--border);background:#121728;padding:6px 10px;border-radius:999px;cursor:pointer}
    .pills{display:flex;flex-wrap:wrap;gap:8px;padding:0 16px;margin-top:-8px}
    .tags-modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:16px}
    .tags-sheet{background:#0f1320;border:1px solid var(--border);border-radius:16px;width:min(1050px,100%);padding:12px}
    .print-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media (max-width:1024px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}.summary{grid-template-columns:repeat(2,minmax(0,1fr))}.filters{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (max-width:640px){.grid{grid-template-columns:repeat(1,minmax(0,1fr))}.filters{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media print{body{background:#fff;color:#000}.no-print{display:none!important}.print-grid{grid-template-columns:repeat(3,minmax(0,1fr))}.tags-sheet{border:none}}
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React 18 + Babel (for JSX in-browser; zero build) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const {useEffect,useMemo,useRef,useState} = React

    const emptyProduct = () => ({
      id: crypto.randomUUID(),
      name: '',
      brand: '',
      category: '',
      subcategory: '',
      size: '750ml',
      abv: '',
      country: '',
      region: '',
      vendor: '',
      sku: '',
      upc: '',
      cost_price: '',
      sell_price: '',
      description: '',
      tasting_notes: '',
      food_pairings: '',
      on_hand: 0,
    })

    const STORAGE_KEY = 'liquor_store_products_v1'
    const SETTINGS_KEY = 'liquor_store_settings_v2'

    const saveToStorage = (products) => localStorage.setItem(STORAGE_KEY, JSON.stringify(products))
    const loadFromStorage = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]') } catch { return [] } }

    const saveSettings = (settings) => localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings))
    const loadSettings = () => { try { return JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}') } catch { return {} } }

    const currency = (n) => isFinite(n) ? Number(n).toLocaleString(undefined, { style: 'currency', currency: 'USD' }) : '—'
    const toNumber = (v) => {
      if (v === null || v === undefined) return NaN
      const num = typeof v === 'number' ? v : parseFloat(String(v).replace(/[^0-9.\-]/g, ''))
      return isNaN(num) ? NaN : num
    }
    const guessCategory = (name) => {
      const n = (name || '').toLowerCase()
      if (/(cabernet|merlot|pinot|chardonnay|sauvignon|malbec|riesling|wine)/.test(n)) return 'Wine'
      if (/(whiskey|whisky|bourbon|rye|scotch)/.test(n)) return 'Whiskey'
      if (/(tequila|mezcal)/.test(n)) return 'Tequila/Mezcal'
      if (/vodka/.test(n)) return 'Vodka'
      if (/gin/.test(n)) return 'Gin'
      if (/rum/.test(n)) return 'Rum'
      if (/(brandy|cognac|armagnac)/.test(n)) return 'Brandy'
      if (/(beer|lager|ipa|stout|ale|porter|pils)/.test(n)) return 'Beer'
      return 'Other'
    }

    // CSV helpers
    function parseCSV(text) {
      const rows = []; let row = [], field = '', inQuotes = false
      for (let i=0;i<text.length;i++) {
        const c = text[i]
        if (c === '"') {
          if (inQuotes && text[i+1] === '"') { field += '"'; i++ }
          else inQuotes = !inQuotes
        } else if (c === ',' && !inQuotes) { row.push(field); field='' }
        else if ((c === '\n' || c === '\r') && !inQuotes) { if (field.length || row.length) { row.push(field); rows.push(row); row=[]; field='' } }
        else field += c
      }
      if (field.length || row.length) { row.push(field); rows.push(row) }
      return rows
    }
    function toCSV(rows) {
      const esc = (s) => { const str = s == null ? '' : String(s); return /[",\n]/.test(str) ? `"${str.replace(/"/g,'""')}"` : str }
      return rows.map(r => r.map(esc).join(',')).join('\n')
    }
    const CSV_HEADERS = [
      'name','brand','category','subcategory','size','abv','country','region','vendor','sku','upc','cost_price','sell_price','description','tasting_notes','food_pairings','on_hand'
    ]

    const sampleProducts = [
      { id: crypto.randomUUID(), name: 'Casa Verde Blanco', brand: 'Casa Verde', category: 'Tequila/Mezcal', subcategory: 'Tequila Blanco', size: '750ml', abv: '40%', country: 'Mexico', region: 'Jalisco', vendor: "Southern Glazer's", sku: 'TEQ-001', upc: '0123456789012', cost_price: 24.5, sell_price: 39.99, description: 'Vibrant agave with citrus and pepper.', tasting_notes: 'Lime zest, white pepper, cooked agave', food_pairings: 'Tacos al pastor, ceviche', on_hand: 18 },
      { id: crypto.randomUUID(), name: 'Old Mill Bourbon 6yr', brand: 'Old Mill', category: 'Whiskey', subcategory: 'Bourbon', size: '750ml', abv: '47%', country: 'USA', region: 'Kentucky', vendor: 'RNDC', sku: 'BRB-201', upc: '0987654321098', cost_price: 27.0, sell_price: 49.99, description: 'Toffee, cherry, and baking spice with a warm finish.', tasting_notes: 'Toffee, cherry, cinnamon', food_pairings: 'Smoked brisket, pecan pie', on_hand: 9 },
      { id: crypto.randomUUID(), name: 'Sunvale Pinot Noir', brand: 'Sunvale', category: 'Wine', subcategory: 'Pinot Noir', size: '750ml', abv: '13.5%', country: 'USA', region: 'Oregon', vendor: 'Premium Brands', sku: 'WPN-310', upc: '0042000000123', cost_price: 12.2, sell_price: 21.99, description: 'Silky red fruit and subtle oak.', tasting_notes: 'Strawberry, cherry, vanilla', food_pairings: 'Roast chicken, mushroom risotto', on_hand: 34 },
    ]

    function App(){
      const [products, setProducts] = useState([])
      const [query, setQuery] = useState('')
      const [admin, setAdmin] = useState(false)
      const [customerView, setCustomerView] = useState(false)
      const [editing, setEditing] = useState(null)
      const [showFilters, setShowFilters] = useState(true)
      const [filters, setFilters] = useState({ category:'', country:'', vendor:'', stock:'', priceRange:[0,200] })
      const [store, setStore] = useState({ name: 'Macadoodles', address: '', phone: '', taxRate: 0, logoUrl:'', primaryColor: '#23c55e' })
      const [gsheetUrl, setGsheetUrl] = useState('')
      const [selected, setSelected] = useState(new Set())
      const [showTags, setShowTags] = useState(false)

      useEffect(()=>{
        const saved = loadFromStorage()
        setProducts(saved.length ? saved : sampleProducts)
        const s = loadSettings(); setStore(prev => ({...prev, ...s}))
      },[])
      useEffect(()=>{ saveToStorage(products) }, [products])
      useEffect(()=>{ saveSettings(store) }, [store])

      const categories = useMemo(()=> [''].concat([...new Set(products.map(p=> p.category || guessCategory(p.name)))].sort()), [products])
      const countries  = useMemo(()=> [''].concat([...new Set(products.map(p=> p.country || ''))].filter(Boolean).sort()), [products])
      const vendors  = useMemo(()=> [''].concat([...new Set(products.map(p=> p.vendor || ''))].filter(Boolean).sort()), [products])

      const filtered = useMemo(()=>{
        const q = query.trim().toLowerCase()
        return products.filter(p=>{
          const inQ = !q || [p.name,p.brand,p.category,p.subcategory,p.country,p.region,p.vendor,p.tasting_notes,p.description,p.food_pairings,p.sku,p.upc]
            .filter(Boolean).some(v=> String(v).toLowerCase().includes(q))
          if (!inQ) return false
          if (filters.category && (p.category || guessCategory(p.name)) !== filters.category) return false
          if (filters.country && p.country !== filters.country) return false
          if (filters.vendor && p.vendor !== filters.vendor) return false
          if (filters.stock==='in' && !(toNumber(p.on_hand)>0)) return false
          if (filters.stock==='out' && !(toNumber(p.on_hand)<=0)) return false
          const price = toNumber(p.sell_price)
          if (isFinite(price)) {
            if (price < filters.priceRange[0] || price > filters.priceRange[1]) return false
          }
          return true
        })
      }, [products, query, filters])

      const totals = useMemo(()=>{
        const cost = filtered.reduce((s,p)=> s + (toNumber(p.cost_price)||0)*(toNumber(p.on_hand)||0), 0)
        const retail = filtered.reduce((s,p)=> s + (toNumber(p.sell_price)||0)*(toNumber(p.on_hand)||0), 0)
        const gp = retail - cost
        return { cost, retail, gp, margin: retail? gp/retail : 0 }
      }, [filtered])

      const startAdd = ()=> setEditing({...emptyProduct(), category: categories[1] || 'Other'})
      const startEdit = (p)=> setEditing({...p})
      const saveEdit = ()=> {
        setProducts(prev=>{
          const i = prev.findIndex(x=> x.id===editing.id)
          if (i>=0) { const copy=[...prev]; copy[i]=editing; return copy }
          return [editing, ...prev]
        })
        setEditing(null)
      }
      const remove = (id)=> setProducts(prev=> prev.filter(p=> p.id!==id))
      const adjustStock = (id, delta)=> setProducts(prev=> prev.map(p=> p.id===id ? {...p, on_hand: (toNumber(p.on_hand)||0)+delta } : p))

      const fileInputRef = useRef(null)
      const downloadTemplate = ()=>{
        const rows = [CSV_HEADERS, [
          'Casa Verde Blanco','Casa Verde','Tequila/Mezcal','Tequila Blanco','750ml','40%','Mexico','Jalisco','Southern Glazer\\'s','TEQ-001','0123456789012','24.50','39.99','Vibrant agave with citrus and pepper.','Lime zest; white pepper; cooked agave','Tacos al pastor; ceviche','18'
        ]]
        const blob = new Blob([toCSV(rows)], {type:'text/csv'})
        const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='product_template.csv'; a.click(); URL.revokeObjectURL(url)
      }
      const exportCSV = ()=>{
        const rows = [CSV_HEADERS, ...products.map(p=> CSV_HEADERS.map(h=> p[h] ?? ''))]
        const blob = new Blob([toCSV(rows)], {type:'text/csv'})
        const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='products_export.csv'; a.click(); URL.revokeObjectURL(url)
      }
      const importCSV = async(file)=>{
        if (!file) return
        const text = await file.text()
        const rows = parseCSV(text).filter(r=> r.length && r.some(x=> x && x.trim().length))
        const header = rows[0].map(h=> h.trim().toLowerCase())
        const idx = (k)=> header.indexOf(k)
        const list = rows.slice(1).map(r=>{
          const o = emptyProduct()
          o.name = r[idx('name')] || ''
          o.brand = r[idx('brand')] || ''
          o.category = r[idx('category')] || guessCategory(o.name)
          o.subcategory = r[idx('subcategory')] || ''
          o.size = r[idx('size')] || ''
          o.abv = r[idx('abv')] || ''
          o.country = r[idx('country')] || ''
          o.region = r[idx('region')] || ''
          o.vendor = r[idx('vendor')] || ''
          o.sku = r[idx('sku')] || ''
          o.upc = r[idx('upc')] || ''
          o.cost_price = toNumber(r[idx('cost_price')])
          o.sell_price = toNumber(r[idx('sell_price')])
          o.description = r[idx('description')] || ''
          o.tasting_notes = r[idx('tasting_notes')] || ''
          o.food_pairings = r[idx('food_pairings')] || ''
          o.on_hand = toNumber(r[idx('on_hand')]) || 0
          return o
        }).filter(x=> x.name)
        if (!list.length) return alert('No valid rows found. Make sure your CSV header matches the template.')
        setProducts(list)
      }
      async function fetchPublishedCSV(url) {
        const res = await fetch(url); if (!res.ok) throw new Error(`Failed: ${res.status}`)
        const text = await res.text(); return parseCSV(text)
      }

      const SummaryCard = ({title, value})=> (
        <div className="card"><div className="content">
          <div className="title">{title}</div>
          <div className="big">{value}</div>
        </div></div>
      )
      const PriceBits = ({p})=>{
        const cost = toNumber(p.cost_price)
        const sell = toNumber(p.sell_price)
        const gp = (isFinite(sell) && isFinite(cost)) ? (sell - cost) : NaN
        const margin = isFinite(sell) && sell>0 ? (gp/sell) : NaN
        return (
          <div className="row" style={{fontSize:13}}>
            {!customerView && <span className="badge">Cost {isFinite(cost)? currency(cost):'—'}</span>}
            <span className="badge">{isFinite(sell)? currency(sell):'—'}</span>
            {!customerView && <span className="badge">{isFinite(gp)? `GP ${currency(gp)}`:'—'}</span>}
            {!customerView && <span className="badge">{isFinite(margin)? (margin*100).toFixed(1)+'%':'—'}</span>}
          </div>
        )
      }

      const ProductCard = ({p})=> (
        <div className="card">
          <div className="content">
            <div className="row" style={{justifyContent:'space-between'}}>
              <div>
                <div className="row" style={{gap:8}}>
                  <div style={{fontWeight:700, fontSize:16}}>{p.name || <span className="muted">(No name)</span>}</div>
                  {toNumber(p.on_hand)<=0 ? <span className="badge red" style={{background:'transparent', border:'1px solid var(--danger)', color:'var(--danger)'}}>Out of stock</span> : <span className="badge">{p.on_hand} on hand</span>}
                </div>
                <div className="muted" style={{fontSize:13}}>{p.brand} · {(p.category || guessCategory(p.name))}{p.subcategory?` · ${p.subcategory}`:''} · {p.size}</div>
              </div>
              {admin && (
                <div className="row">
                  <button className="btn" onClick={()=>setEditing({...p})}>Edit</button>
                  <button className="btn" style={{color:'#ef4444'}} onClick={()=> setProducts(prev=> prev.filter(x=> x.id!==p.id))}>Delete</button>
                </div>
              )}
            </div>
            <div style={{height:8}}/>
            <PriceBits p={p}/>
            <div style={{fontSize:13, marginTop:6}}>{p.description}</div>
            <div style={{fontSize:13}}><strong>Tasting:</strong> {p.tasting_notes || '—'}</div>
            <div style={{fontSize:13}}><strong>Pairs with:</strong> {p.food_pairings || '—'}</div>
            <div className="muted" style={{fontSize:12}}>Origin: {p.country}{p.region?`, ${p.region}`:''} · Vendor: {p.vendor || '—'} · SKU: {p.sku || '—'} · UPC: {p.upc || '—'}</div>
            {admin && (
              <div className="row">
                <button className="btn" onClick={()=>adjustStock(p.id, 1)}>+1</button>
                <button className="btn" onClick={()=>adjustStock(p.id, -1)} disabled={toNumber(p.on_hand)<=0}>-1</button>
              </div>
            )}
          </div>
        </div>
      )

      const ProductEditor = () => editing && (
        <div className="tags-modal" onClick={()=> setEditing(null)}>
          <div className="tags-sheet" onClick={e=> e.stopPropagation()}>
            <div className="row" style={{justifyContent:'space-between', marginBottom:8}}>
              <strong>{products.some(p=>p.id===editing?.id)?'Edit Product':'Add Product'}</strong>
              <div className="row">
                <button className="btn" onClick={()=> setEditing(null)}>Cancel</button>
                <button className="btn" onClick={()=>{
                  setProducts(prev=>{
                    const i = prev.findIndex(x=> x.id===editing.id)
                    if (i>=0) { const copy=[...prev]; copy[i]=editing; return copy }
                    return [editing, ...prev]
                  })
                  setEditing(null)
                }}>Save</button>
              </div>
            </div>
            <div className="row" style={{flexWrap:'wrap', gap:10}}>
              {['name','brand','category','subcategory','size','abv','country','region','vendor','sku','upc','cost_price','sell_price','on_hand'].map(key => (
                <div key={key} style={{minWidth:220}}>
                  <div className="muted" style={{fontSize:12}}>{key.replace('_',' ').toUpperCase()}</div>
                  <input className="input" value={editing[key] ?? ''}
                    onChange={e=> setEditing(v=>({...v,[key]: ['cost_price','sell_price','on_hand'].includes(key) ? toNumber(e.target.value) : e.target.value}))}/>
                </div>
              ))}
              <div style={{width:'100%'}}>
                <div className="muted" style={{fontSize:12}}>DESCRIPTION</div>
                <textarea className="input" rows="3" value={editing.description} onChange={e=> setEditing(v=>({...v, description:e.target.value}))}/>
              </div>
              <div style={{width:'100%'}}>
                <div className="muted" style={{fontSize:12}}>TASTING NOTES</div>
                <textarea className="input" rows="2" value={editing.tasting_notes} onChange={e=> setEditing(v=>({...v, tasting_notes:e.target.value}))}/>
              </div>
              <div style={{width:'100%'}}>
                <div className="muted" style={{fontSize:12}}>FOOD PAIRINGS</div>
                <textarea className="input" rows="2" value={editing.food_pairings} onChange={e=> setEditing(v=>({...v, food_pairings:e.target.value}))}/>
              </div>
            </div>
          </div>
        </div>
      )

      return (
        <div>
          <div className="header no-print">
            <div className="header-row">
              <div className="brand"><span style={{color: store.primaryColor}}>{store.name || 'Your Store'}</span></div>
              <div className="grow"></div>
              <button className="btn" onClick={()=> setCustomerView(v=>!v)}>Customer</button>
              <button className="btn" onClick={()=> setAdmin(v=>!v)}>Admin</button>
              <div className="row" style={{position:'relative'}}>
                <input className="input" style={{width:260}} placeholder="Search products, vendors, notes…" value={query} onChange={e=>setQuery(e.target.value)}/>
              </div>
            </div>
          </div>

          <div className="container" style={{paddingTop:16}}>
            <div className="summary no-print">
              <SummaryCard title="Inventory Cost" value={currency(totals.cost)} />
              <SummaryCard title="Retail Value" value={currency(totals.retail)} />
              {!customerView && <SummaryCard title="Gross Profit" value={currency(totals.gp)} />}
              {!customerView && <SummaryCard title="Margin" value={(totals.margin*100).toFixed(1)+'%'} />}
            </div>
          </div>

          {/* Filters */}
          {showFilters && (
            <div className="filters no-print">
              <div>
                <div className="muted" style={{fontSize:12}}>Category</div>
                <select className="select" value={filters.category} onChange={e=> setFilters(v=>({...v, category:e.target.value}))}>
                  {['', ...new Set(categories)].map(c=> <option key={c} value={c}>{c || 'All'}</option>)}
                </select>
              </div>
              <div>
                <div className="muted" style={{fontSize:12}}>Country</div>
                <select className="select" value={filters.country} onChange={e=> setFilters(v=>({...v, country:e.target.value}))}>
                  {['', ...new Set(countries)].map(c=> <option key={c} value={c}>{c || 'All'}</option>)}
                </select>
              </div>
              <div>
                <div className="muted" style={{fontSize:12}}>Vendor</div>
                <select className="select" value={filters.vendor} onChange={e=> setFilters(v=>({...v, vendor:e.target.value}))}>
                  {['', ...new Set(vendors)].map(c=> <option key={c} value={c}>{c || 'All'}</option>)}
                </select>
              </div>
              <div>
                <div className="muted" style={{fontSize:12}}>Stock</div>
                <select className="select" value={filters.stock} onChange={e=> setFilters(v=>({...v, stock:e.target.value}))}>
                  <option value="">All</option>
                  <option value="in">In stock</option>
                  <option value="out">Out of stock</option>
                </select>
              </div>
              <div style={{gridColumn:'span 2'}}>
                <div className="muted" style={{fontSize:12}}>Price Range: ${filters.priceRange[0]} – ${filters.priceRange[1]}</div>
                <input type="range" min="0" max="200" step="1" value={filters.priceRange[0]} onChange={e=> setFilters(v=>({...v, priceRange:[Number(e.target.value), v.priceRange[1]]}))}/>
                <input type="range" min="0" max="200" step="1" value={filters.priceRange[1]} onChange={e=> setFilters(v=>({...v, priceRange:[v.priceRange[0], Number(e.target.value)]}))}/>
              </div>
            </div>
          )}

          {/* Toolbar */}
          <div className="container no-print" style={{display:'flex', alignItems:'center', gap:8, paddingTop:8, paddingBottom:8}}>
            {admin && (
              <>
                <button className="btn" onClick={()=> setEditing(emptyProduct())}>Add Product</button>
                <input id="fileInput" type="file" accept=".csv" style={{display:'none'}} onChange={(e)=> importCSV(e.target.files?.[0])}/>
                <label for="fileInput" className="btn" style="cursor:pointer;">Import CSV</label>
                <button className="btn" onClick={exportCSV}>Export CSV</button>
                <button className="btn" onClick={downloadTemplate}>Template</button>
                <div className="row" style={{marginLeft:8}}>
                  <input className="input" placeholder="Published Google Sheet CSV URL" style={{width:360}} value={gsheetUrl} onChange={e=> setGsheetUrl(e.target.value)}/>
                  <button className="btn" onClick={async()=>{
                    try{
                      const rows = await fetchPublishedCSV(gsheetUrl)
                      if (!rows.length) return alert('No rows found in the CSV.')
                      const header = rows[0].map(h=> String(h||'').trim().toLowerCase())
                      const idx = (k)=> header.indexOf(k)
                      const list = rows.slice(1).map(r=>{
                        const o = emptyProduct()
                        o.name = r[idx('name')]|| r[idx('product')] || r[idx('item')] || ''
                        o.brand = r[idx('brand')]||''
                        o.category = r[idx('category')]|| guessCategory(o.name)
                        o.subcategory = r[idx('subcategory')]||''
                        o.size = r[idx('size')]||''
                        o.abv = r[idx('abv')]||''
                        o.country = r[idx('country')]||''
                        o.region = r[idx('region')]||''
                        o.vendor = r[idx('vendor')]||''
                        o.sku = r[idx('sku')]|| r[idx('item id')] || ''
                        o.upc = r[idx('upc')]||''
                        o.cost_price = toNumber(r[idx('cost_price')]|| r[idx('cost')])
                        o.sell_price = toNumber(r[idx('sell_price')]|| r[idx('price')]|| r[idx('base price')])
                        o.description = r[idx('description')]||''
                        o.tasting_notes = r[idx('tasting_notes')]||''
                        o.food_pairings = r[idx('food_pairings')]||''
                        o.on_hand = toNumber(r[idx('on_hand')]|| r[idx('qty')]|| r[idx('on hand')]) || 0
                        return o
                      }).filter(x=> x.name)
                      if (!list.length) return alert('Could not map any rows. Make sure your sheet has a header row.')
                      setProducts(list)
                      alert('Imported from Google Sheets!')
                    }catch(e){ console.error(e); alert('Import failed: '+ e.message) }
                  }}>Import Google Sheet</button>
                </div>
              </>
            )}
            <div className="grow"></div>
            <div className="row muted">Items: {filtered.length}</div>
          </div>

          {/* Store settings (Admin) */}
          {admin && (
            <div className="container">
              <div className="card"><div className="content">
                <div className="title">Store Settings</div>
                <div className="row" style={{gap:12, flexWrap:'wrap'}}>
                  <div><div className="muted" style={{fontSize:12}}>Store Name</div><input className="input" value={store.name} onChange={e=> setStore({...store, name:e.target.value})}/></div>
                  <div><div className="muted" style={{fontSize:12}}>Phone</div><input className="input" value={store.phone} onChange={e=> setStore({...store, phone:e.target.value})}/></div>
                  <div style={{minWidth:320}}><div className="muted" style={{fontSize:12}}>Address</div><input className="input" value={store.address} onChange={e=> setStore({...store, address:e.target.value})}/></div>
                  <div><div className="muted" style={{fontSize:12}}>Sales Tax (%)</div><input className="input" value={store.taxRate} onChange={e=> setStore({...store, taxRate: toNumber(e.target.value)||0})}/></div>
                  <div style={{minWidth:320}}><div className="muted" style={{fontSize:12}}>Logo URL</div><input className="input" placeholder="https://.../logo.png" value={store.logoUrl} onChange={e=> setStore({...store, logoUrl:e.target.value})}/></div>
                  <div><div className="muted" style={{fontSize:12}}>Brand Color (hex)</div><input className="input" placeholder="#23c55e" value={store.primaryColor} onChange={e=> setStore({...store, primaryColor:e.target.value})}/></div>
                </div>
              </div></div>
            </div>
          )}

          {/* Products */}
          <div className="container">
            <div className="grid">
              {filtered.map(p=> <ProductCard key={p.id} p={p} />)}
            </div>
          </div>

          {/* Editor */}
          {editing && <ProductEditor />}

          {/* Shelf tags modal */}
          {showTags && (
            <div className="tags-modal" onClick={()=> setShowTags(false)}>
              <div className="tags-sheet" onClick={(e)=> e.stopPropagation()}>
                <div className="row" style={{justifyContent:'space-between', marginBottom:8}}>
                  <div style={{fontWeight:700}}>Shelf Tags Preview</div>
                  <div className="row">
                    <button className="btn" onClick={()=> setShowTags(false)}>Close</button>
                    <button className="btn" onClick={()=> window.print()}>Print</button>
                  </div>
                </div>
                <div className="print-grid">
                  {products.filter(p=> selected.has(p.id)).map(p=> (
                    <div key={p.id} className="card"><div className="content">
                      <div className="row" style={{gap:8, alignItems:'center'}}>
                        {!!store.logoUrl && <img src={store.logoUrl} alt="logo" style={{width:22, height:22}}/>}
                        <div className="muted" style={{fontSize:12}}>{store.name || 'Store'}</div>
                      </div>
                      <div style={{fontWeight:700, lineHeight:1.2}}>{p.name}</div>
                      <div className="muted" style={{fontSize:12}}>{p.size || p.category}</div>
                      <div style={{fontSize:24, fontWeight:800, color: store.primaryColor}}>{currency(toNumber(p.sell_price)||0)}</div>
                      {!!p.tasting_notes && <div style={{fontSize:12, marginTop:6}}>{p.tasting_notes}</div>}
                      {!!p.food_pairings && <div className="muted" style={{fontSize:11, marginTop:4}}>Pairs: {p.food_pairings}</div>}
                      {!!p.upc && <div className="muted" style={{fontSize:11, marginTop:8}}>UPC: {p.upc}</div>}
                    </div></div>
                  ))}
                </div>
              </div>
            </div>
          )}

          <div className="container muted" style={{fontSize:12, textAlign:'center', padding:'24px 0'}}>
            © {new Date().getFullYear()} {store.name || 'Your Store'}
          </div>
        </div>
      )
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />)
  </script>
</body>
</html>
